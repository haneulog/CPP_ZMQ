#include <zmq.hpp>
#include <string>
#include <iostream>
#include <random>
#include <chrono>
#include <thread>

int main(int argc, char* argv[]){
  zmq::context_t con(1);
  zmq::socket_t subscriber(con, ZMQ_SUB);
  zmq::socket_t publisher(con, ZMQ_PUSH);
  subscriber.set(zmq::sockopt::subscribe, "");
  subscriber.connect("tcp://localhost:5557");
  publisher.connect("tcp://localhost:5558");
  std::string clientID = (argc > 1) ? argv[1] : std::string("client");
  std::mt19937 gen(static_cast<unsigned int>(
    std::chrono::system_clock::now().time_since_epoch().count()));
  std::uniform_int_distribution<int> dist(1, 100);

  while (true){
    zmq::pollitem_t items[] = {
      {static_cast<void*>(subscriber), 0, ZMQ_POLLIN, 0}
    };
    zmq::poll(items, 1, std::chrono::milliseconds(100));
    if (items[0].revents & ZMQ_POLLIN){
      zmq::message_t msg;
      subscriber.recv(msg, zmq::recv_flags::none);
      std::string remsg(static_cast<char*>(msg.data()), msg.size());
      std::cout << clientID << ": receive status => " << remsg << std::endl;
    }
    else {
      int randVal = dist(gen);
      if (randVal < 10){
        std::this_thread::sleep_for(std::chrono::seconds(1));
        std::string sendtext = "(" + clientID + ": ON)"; 
        zmq::message_t msg(sendtext.size());
        memcpy(msg.data(), sendtext.data(), sendtext.size());
        publisher.send(msg, zmq::send_flags::none);
        std::cout << clientID << ": send status - activated" << std::endl;
      }
      else if (randVal > 90){
        std::this_thread::sleep_for(std::chrono::seconds(1));
        std::string sendtext = "(" + clientID + ": OFF)";
        zmq::message_t msg(sendtext.size());
        memcpy(msg.data(), sendtext.data(), sendtext.size());
        publisher.send(msg, zmq::send_flags::none);
        std::cout << clientID << ": send status - deactivated" << std::endl;
      }
    }
  }
  return 0;
}
