#include <zmq.hpp>
#include <string>
#include <iostream>
#include <thread>
#include <chrono>

// Hello world server in Cpp
// Binds REP socket to tcp://*:5555
// Expects "Hello" from client, replies with "world"

int main(){
  zmq::context_t con(1);
  zmq::socket_t sock(con, ZMQ_REP);
  sock.bind("tcp://*:5555");
  std::cout << "REP Server running at tcp://*:5555" << std::endl;

  while (true){
  // Wait for next request from client
    zmq::message_t req;
    sock.recv(req, zmq::recv_flags::none);
    std::string remsg(static_cast<char*>(req.data()), req.size());
    std::cout << "Received request: " << remsg << std::endl;

  // Do some 'work'
    std::this_thread::sleep_for(std::chrono::seconds(1));

  // Send reply back to client
    std::string replytext = "World";
    zmq::message_t rep(replytext.size());
    memcpy(rep.data(), replytext.data(), replytext.size());
    sock.send(rep, zmq::send_flags::none);
  }
  return 0;
}
